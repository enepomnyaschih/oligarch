var OW={mapSize:32,cellSize:16,surfaceI:5,stoneI:8,oilI:12,diggerSpeed:0.1,stoneAmount:10,oilAmount:10,maxPunksAllowed:5,blindingTime:100,explosionTime:25,dir:[[1,0],[0,1],[-1,0],[0,-1]],map:{sky:1,ground:2,stone:3,oil:4,digged:5,metan:6},sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()}};OW.Quest=function(a){OW.Quest._super.call(this);this.turn=a.turn;this.duration=a.duration};JW.extend(OW.Quest,JW.Class,{createData:function(a){}});OW.App=function(a){OW.App._super.call(this);this.data=a;this.levels=this.own(new JW.ObservableArray()).ownItems()};JW.extend(OW.App,JW.UI.Component,{renderLevelList:function(){this.own(new JW.Updater([this.data.lsLevelIndex],function(a){for(var b=this.levels.getLength();b<Math.min(a+1,OW.Level.itemArray.length);++b){this.levels.add(new OW.LevelBadge(this.data,OW.Level.itemArray[b]))}},this));return this.levels},renderLevel:function(){return this.own(new JW.Mapper([this.data.levelData],{createValue:function(a){return new OW.LevelView(a)},destroyValue:JW.destroy,scope:this})).target}});JW.UI.template(OW.App,{main:'<div jwclass="ow-app"><div jwid="levels"><h3 style="text-align: center">Level list</h3><div jwid="level-list"></div></div><div jwid="level" ow-blank></div><div class="ow-clear"></div></div>'});OW.Data=function(){OW.Data._super.call(this);this.lsLevelIndex=this.own(new JW.Property(this._getLsLevelIndex()));this.levelIndex=this.own(new JW.Property(this.lsLevelIndex.get()));this.level=this.own(new JW.Functor([this.levelIndex],function(a){var b=Math.max(a,this.lsLevelIndex.get());localStorage.owLevelIndex=b;this.lsLevelIndex.set(b);return OW.Level.itemArray[a]},this)).target;this.levelData=this.own(new JW.Mapper([this.level],{createValue:function(a){return new OW.LevelData(this,a,this.levelIndex.get())},destroyValue:JW.destroy,scope:this})).target};JW.extend(OW.Data,JW.Class,{nextLevel:function(){this.levelIndex.set(this.levelIndex.get()+1)},_getLsLevelIndex:function(){return +(localStorage.owLevelIndex||0)}});OW.El={xy:function(b,a){b.css({left:a[1]+"px",top:a[0]+"px"})},size:function(b,a){b.css({width:a[1]+"px",height:a[0]+"px"})}};OW.Explosion=function(a,b){OW.Explosion._super.call(this);this.floatIj=a;this.size=b||48;this.time=this.own(new JW.Property(OW.explosionTime))};JW.extend(OW.Explosion,JW.Class,{move:function(){},isOut:function(){}});OW.ExplosionView=function(a){OW.ExplosionView._super.call(this);this.explosion=a};JW.extend(OW.ExplosionView,JW.UI.Component,{renderRoot:function(b){OW.El.xy(b,OW.Vector.add(this.explosion.floatIj,[-this.explosion.size/2,-this.explosion.size/2]));b.addClass("ow-explosion");var a=this.own(new JW.Functor([this.explosion.time],function(c){return c/OW.explosionTime},this)).target;this.own(new JW.UI.CssUpdater(b,"opacity",a))}});OW.Fax=function(a){OW.Fax._super.call(this,a);this.html=a.html;this.answer=a.answer;this.wrongMessage=a.wrongMessage};JW.extend(OW.Fax,OW.Quest,{createData:function(a){return new OW.FaxData(a,this,this)}});OW.FaxData=function(b,c,a){OW.FaxData._super.call(this);this.levelData=b;this.quest=c;this.config=a};JW.extend(OW.FaxData,JW.Class,{createPanel:function(){return new OW.FaxPanel(this)},submit:function(a){if(a===this.config.answer){this.levelData.winQuest()}else{alert(this.config.wrongMessage);this.levelData.restart()}}});OW.FaxPanel=function(a){OW.FaxPanel._super.call(this);this.faxData=a};JW.extend(OW.FaxPanel,JW.UI.Component,{renderPrinter:function(b){b.click(JW.inScope(function(){this.el.addClass("o-open");return false},this));var a=0;this.own(new JW.Interval(function(){if(this.el.hasClass("o-open")){return}b.toggleClass("o-blink");if(a%20<7){OW.sound("fax")}++a},this,150))},renderHtml:function(a){a.html(this.faxData.config.html)},renderForm:function(a){a.submit(JW.inScope(function(){this.faxData.submit(JW.String.trim(this.getElement("input").val()));return false},this))}});JW.UI.template(OW.FaxPanel,{main:'<div jwclass="ow-fax"><a href="#" jwid="printer" class="blocklink"></a><div jwid="content"><div jwid="html"></div><form jwid="form"><input jwid="input" type="text"><input type="submit" value="Submit"></form></div></div>'});OW.Jail=function(a){OW.Jail._super.call(this,a)};JW.extend(OW.Jail,OW.Quest,{createData:function(a){return new OW.JailData(a,this)}});OW.JailData=function(b,a){OW.JailData._super.call(this);this.levelData=b;this.quest=a;this.count=Math.floor(7*Math.random())+4};JW.extend(OW.JailData,JW.Class,{createPanel:function(){return new OW.JailPanel(this)}});OW.JailPanel=function(a){OW.JailPanel._super.call(this);this.jailData=a};JW.extend(OW.JailPanel,JW.UI.Component,{renderPhone:function(b){b.click(JW.inScope(function(){this.el.addClass("o-open");return false},this));var a=0;this.own(new JW.Interval(function(){if(this.el.hasClass("o-open")){return}b.toggleClass("o-blink");if(a%20<7){OW.sound("fax")}++a},this,150))},renderCount:function(a){a.text(this.jailData.count)},renderAccept:function(a){a.click(JW.inScope(function(){this.jailData.levelData.jailCount.set(this.jailData.count);this.jailData.levelData.winQuest()},this))}});JW.UI.template(OW.JailPanel,{main:'<div jwclass="ow-jail"><a href="#" jwid="phone" class="blocklink"></a><div jwid="content"><h3>Call from judo buddy (first priority)</h3><p>Starting from this point on, you must <b>arrest every <span jwid="count"></span>\'th</b> Greenpeace member instead of repelling them.</p><button jwid="accept">Start quest</button></div></div>'});OW.Level=function(a){OW.Level._super.call(this);this.id=a.id;this.name=a.name;this.theme=a.theme;this.countStone=a.countStone||0;this.countOil=a.countOil||0;this.countMetan=a.countMetan||0;this.countSurface=a.countSurface||0;this.countBeneath=a.countBeneath||0;this.probPhoto=a.probPhoto||0;this.probAuto=a.probAuto||0;this.quests=a.quests;this.map=new OW.Matrix(OW.mapSize);for(var g=0;g<this.map.size;++g){for(var f=0;f<this.map.size;++f){this.map.setCell([g,f],(g<OW.surfaceI)?OW.map.sky:OW.map.ground)}}for(var e=0;e<this.countStone;++e){var r=[Math.floor((this.map.size-OW.stoneI)*Math.random())+OW.stoneI,Math.floor(this.map.size*Math.random())];var q=[r];var s={};s[r.join()]=true;for(var b=0;q.length&&(b<OW.stoneAmount);++b){var h=Math.floor(q.length*Math.random());var o=q[h];q.splice(h,1);this.map.setCell(o,OW.map.stone);for(var l=0;l<OW.dir.length;++l){var n=OW.Vector.add(o,OW.dir[l]);if(!this.map.inMatrix(n)||(n[0]<=OW.surfaceI)||s[n.join()]){continue}q.push(n);s[n.join()]=true}}}for(var e=0;e<this.countMetan;++e){var r=[Math.floor((this.map.size-OW.stoneI)*Math.random())+OW.stoneI,Math.floor(this.map.size*Math.random())];this.map.setCell(r,OW.map.metan)}for(var e=0;e<this.countOil;++e){var r=[Math.floor((this.map.size-OW.oilI)*Math.random())+OW.oilI,Math.floor(this.map.size*Math.random())];if(this.map.getCell(r)===OW.map.oil){--e;continue}var q=[r];var s={};s[r.join()]=true;for(var b=0;q.length&&(b<OW.stoneAmount);++b){var h=Math.floor(q.length*Math.random());var o=q[h];q.splice(h,1);this.map.setCell(o,OW.map.oil);for(var l=0;l<OW.dir.length;++l){var n=OW.Vector.add(o,OW.dir[l]);if(!this.map.inMatrix(n)||(n[0]<OW.oilI)||s[n.join()]){continue}var p=this.map.getCell(n);if(p===OW.map.oil){continue}q.push(n);s[n.join()]=true}}}for(var g=0;g<this.map.size;++g){for(var f=0;f<this.map.size;++f){var r=[g,f];if(this.map.getCell(r)!==OW.map.oil){continue}for(var l=0;l<OW.dir.length;++l){var n=OW.Vector.add(r,OW.dir[l]);if(!this.map.inMatrix(n)){continue}var c=this.map.getCell(n);if((c===OW.map.ground)||(c===OW.map.metan)){this.map.setCell(n,OW.map.stone)}}}}};JW.extend(OW.Level,JW.Class);JW.makeRegistry(OW.Level);OW.LevelBadge=function(a,b){OW.LevelBadge._super.call(this);this.data=a;this.level=b};JW.extend(OW.LevelBadge,JW.UI.Component,{renderRoot:function(a){a.text(this.level.name);a.click(JW.inScope(function(){this.data.levelIndex.set(OW.Level.itemArray.indexOf(this.level));return false},this))}});JW.UI.template(OW.LevelBadge,{main:'<a href="#" jwclass="ow-level-badge" class="blocklink"></a>'});OW.LevelData=function(e,a,b){OW.LevelData._super.call(this);
this.data=e;this.level=a;this.levelIndex=b;this.map=new OW.Matrix(a.map.size);var c=0;for(var f=0;f<a.map.size;++f){for(var d=0;d<a.map.size;++d){var h=[f,d];var k=a.map.getCell(h);this.map.setCell(h,k);if(k===OW.map.oil){++c}}}this.diggedCells={};this.diggerIj=[OW.surfaceI,Math.floor(a.map.size/2)];this.diggerDir=0;this.selectedDir=0;this.diggerOffset=0;this.oilRemaining=this.own(new JW.Property(c));this.tubes=this.own(new JW.ObservableArray()).ownItems();var g=this._createTube();g.ij1.set(OW.Vector.add(g.ij1.get(),[-0.5,0]));this.punks=this.own(new JW.ObservableArray()).ownItems();this.punkWins=this.own(new JW.ObservableArray()).ownItems();this.explosions=this.own(new JW.ObservableArray()).ownItems();this.punkPwns=this.own(new JW.ObservableArray()).ownItems();this.blinding=this.own(new JW.Property(0));this.questData=this.own(new JW.Property()).ownValue();this.questTime=this.own(new JW.Property());this.levelQuestIndex=0;this.jailCount=this.own(new JW.Property());this.jailCurrent=0;this.arrestCursor=this.own(new JW.Property(false));this.turn=0;this.turnEvent=this.own(new JW.Event());this.cellChangeEvent=this.own(new JW.Event());this.interval=this.own(new JW.Property()).ownValue()};JW.extend(OW.LevelData,JW.Class,{start:function(){if(!this.interval.get()){this.interval.set(new JW.Interval(this.nextTurn,this,40))}},stop:function(){this.interval.set()},toggleStart:function(){this.interval.get()?this.stop():this.start()},setCell:function(b,c){var a=this.map.getCell(b);if(a===c){return}this.map.setCell(b,c);if(a===OW.map.oil){this.oilRemaining.set(this.oilRemaining.get()-1)}if(c===OW.map.oil){this.oilRemaining.set(this.oilRemaining.get()+1)}this.cellChangeEvent.trigger(b)},nextTurn:function(){if(!this.explosions.isEmpty()){alert("Something has exploded!");this.restart();return}var p=this.oilRemaining.get();var a=OW.diggerSpeed;if(this.diggerOffset<0){this.diggerOffset+=a;if(this.diggerOffset>0){a=this.diggerOffset;this.diggerOffset=0}else{a=0}this._updateTube()}if(a){if(this.diggerOffset===0){if(this.map.getCell(this.diggerIj)===OW.map.ground){OW.sound("drill")}this.setCell(this.diggerIj,OW.map.digged);this.diggedCells[this.diggerIj.join()]=true;for(var k=0;k<OW.dir.length;++k){var l=OW.Vector.add(this.diggerIj,OW.dir[k]);if(this.map.getCell(l)===OW.map.metan){OW.sound("explosion");this.explosions.add(new OW.Explosion(OW.Vector.mult(OW.Vector.add(l,[0.5,0.5]),OW.cellSize)))}}if(this.diggerDir%2!==this.selectedDir%2){this.diggerDir=this.selectedDir;this._createTube()}}if((this.diggerOffset!==0)||(this.diggerDir===this.selectedDir)){var b=this.getDigIj();if(this.map.inMatrix(b)){if(this.diggedCells[b.join()]){OW.sound("explosion");this.explosions.add(new OW.Explosion(OW.Vector.mult(OW.Vector.add(b,[0.5,0.5]),OW.cellSize)))}if((this.map.getCell(b)!==OW.map.stone)&&(b[0]>OW.surfaceI)){this.diggerOffset+=a;if(this.diggerOffset>0.5){this.diggerOffset-=1;this.diggerIj=b}this._updateTube()}}}}if(this.map.getCell(this.diggerIj)===OW.map.oil){this.setCell(this.diggerIj,OW.map.digged)}if(this.turn%6===0){var r=(this.turn%12===0);for(var f=this.map.size-1;f>=0;--f){for(var e=0;e<this.map.size;++e){var o=[f,r?e:(this.map.size-e-1)];var n=this.map.getCell(o);if(n===OW.map.oil){if(this._tryOilCrawl(o,[1,0])){continue}var q=[0,r?-1:1];var l=OW.Vector.add(o,q);var m=OW.Vector.add(l,[1,0]);if(OW.Vector.equal(m,this.diggerIj)&&(OW.dir[this.diggerDir][1]===(r?1:-1))){continue}var c=this.map.getCell(m);if(c===OW.map.digged){this._tryOilCrawl(o,q)}}}}}this.punks.each(JW.byMethod("move"));this.punkWins.each(JW.byMethod("move"));this.punkPwns.each(JW.byMethod("move"));var h=this.punks.$filter(JW.byMethod("isWin"));h.each(function(d){this.punkWins.add(new OW.PunkWin());this.punks.removeItem(d)},this);if(!h.isEmpty()){OW.sound("jump");this.punkWins.sort(JW.byField("y"))}if(Math.random()<this.level.countSurface/200){this.punks.add(new OW.Punk(this))}this.punkPwns.removeItems(this.punkPwns.filter(JW.byMethod("isOut")));if(this.oilRemaining.get()===0){alert("You win!");this.data.nextLevel();return}if(this.punkWins.length.get()>=OW.maxPunksAllowed){alert("Too much Greenpeace got onto the platform!");this.restart();return}this.blinding.set(Math.max(0,this.blinding.get()-1));var g=JW.get(this.level,["quests",this.levelQuestIndex]);if(g&&(g.turn===this.turn)){this.questTime.set(g.duration);this.questData.set(g.createData(this));++this.levelQuestIndex}if(JW.isSet(this.questTime.get())){this.questTime.set(this.questTime.get()-1);if(this.questTime.get()===0){alert("You couldn't deal with the quest in time!");this.restart();return}}this.turn++;this.turnEvent.trigger();if(p!==this.oilRemaining.get()){OW.sound("oil")}},getFloatIj:function(){return OW.Vector.add(this.diggerIj,OW.Vector.mult(OW.dir[this.diggerDir],this.diggerOffset))},getDigIj:function(){return OW.Vector.add(this.diggerIj,OW.dir[this.diggerDir])},restart:function(){var a=this.data.levelIndex.get();this.data.levelIndex.set(null);this.data.levelIndex.set(a);this.data.levelData.get().start()},winQuest:function(){this.questData.set(null);this.questTime.set(null)},pwn:function(a){var c=this.jailCount.get();if(JW.isSet(c)){if(!this.arrestCursor.get()&&!a.auto&&(this.jailCurrent===c-1)){alert("You repelled a Greenpeace member that you must've arrested!");this.restart();return}if(this.arrestCursor.get()&&(this.jailCurrent!==c-1)){alert("You arrested a Greenpeace member that you must've repelled!");this.restart();return}}if(this.arrestCursor.get()){this.pwnNow(a);OW.sound("arrest")}else{if(a.auto){this.punkPwns.add(new OW.PunkPwn(a,"o-auto"));var b=new OW.Punk(this);b.dir=a.dir;b.x.set(a.x.get());b.speed=a.speed/2;b.photo=false;b.auto=false;this.punks.add(b);this.punks.removeItem(a);OW.sound("hit-auto")}else{this.pwnNow(a);OW.sound("hit")}}},pwnNow:function(a){this.punkPwns.add(new OW.PunkPwn(a,this.arrestCursor.get()?"o-arrest":null));this.punks.removeItem(a);if(JW.isSet(this.jailCount.get())){if(this.arrestCursor.get()){this.jailCurrent=0}else{++this.jailCurrent}}},_createTube:function(){var a=new OW.Tube(this.diggerIj,this.diggerDir);this.tubes.add(a);return a},_updateTube:function(){var a=this.tubes.getLast();a.ij2.set(this.getFloatIj())},_tryOilCrawl:function(c,a){var b=OW.Vector.add(c,a);if(this.map.getCell(b)===OW.map.digged){this.setCell(b,OW.map.oil);this.setCell(c,OW.map.digged);return true}return false}});OW.LevelView=function(a){this._onKeyDown=JW.inScope(this._onKeyDown,this);this._onMouseMove=JW.inScope(this._onMouseMove,this);this._onMouseDown=JW.inScope(this._onMouseDown,this);OW.LevelView._super.call(this);this.levelData=a};JW.extend(OW.LevelView,JW.UI.Component,{renderRoot:function(a){a.addClass("o-"+this.levelData.level.theme);jQuery(window).bind("keydown",this._onKeyDown);jQuery(window).bind("mousemove",this._onMouseMove);jQuery(window).bind("mousedown",this._onMouseDown)},renderStartScreen:function(a){a.attr("ow-level","o"+this.levelData.levelIndex);var b=this.own(new JW.Functor([this.levelData.interval],function(c){return !c},this)).target;this.own(new JW.UI.VisibleUpdater(a,b))},renderStart:function(a){a.click(JW.inScope(function(){this.levelData.start();return false},this))},renderPlayScreen:function(a){this.own(new JW.UI.VisibleUpdater(a,this.levelData.interval))},renderMonitor:function(){return this.own(new OW.Monitor(this.levelData))},renderArrest:function(a){this.own(new JW.UI.ClassUpdater(a,"o-enabled",this.levelData.jailCount));a.click(JW.inScope(function(){this.levelData.arrestCursor.set(true)},this))},renderOilRemaining:function(a){this.own(new JW.UI.TextUpdater(a,this.levelData.oilRemaining))},renderQuest:function(a){this.own(new JW.UI.VisibleUpdater(a,this.levelData.questData))},renderQuestTime:function(){return this.own(new JW.Mapper([this.levelData.questData],{createValue:function(a){return new OW.Progress(this.levelData.questTime,new JW.Property(a.quest.duration))},destroyValue:JW.destroy,scope:this})).target},renderQuestPanel:function(){return this.own(new JW.Mapper([this.levelData.questData],{createValue:function(a){return a.createPanel()
},destroyValue:JW.destroy,scope:this})).target},renderArrestCursor:function(a){this.own(new JW.UI.VisibleUpdater(a,this.levelData.arrestCursor))},destroyComponent:function(){jQuery(window).unbind("keydown",this._onKeyDown);jQuery(window).unbind("mousemove",this._onMouseMove);jQuery(window).unbind("mousedown",this._onMouseDown);this._super()},_onKeyDown:function(a){if(jQuery(a.target).is("input[type=text]")){return}switch(a.keyCode){case 40:this.levelData.selectedDir=0;break;case 39:this.levelData.selectedDir=1;break;case 38:this.levelData.selectedDir=2;break;case 37:this.levelData.selectedDir=3;break;case 32:this.levelData.toggleStart();break}},_onMouseMove:function(a){var b=this.el.position();this.getElement("arrest-cursor").css({left:(Math.min(jQuery(window).width()-56,a.pageX)-b.left+20)+"px",top:(Math.min(jQuery(window).height()-56,a.pageY)-b.top+20)+"px"})},_onMouseDown:function(){this.levelData.arrestCursor.set(false)}});JW.UI.template(OW.LevelView,{main:'<div jwclass="ow-level"><div jwid="start-screen"><a href="#" jwid="start" class="blocklink"></a></div><div jwid="play-screen"><div jwid="monitor"></div><div jwid="sidebar"><div><a href="#" jwid="arrest" class="blocklink"></a></div><div>Oil remaining: <span jwid="oil-remaining"></span></div><div jwid="quest"><div>Quest time: <div jwid="quest-time"></div><div jwid="quest-panel"></div></div></div><div jwid="arrest-cursor"></div><div class="ow-clear"></div></div></div>'});OW.Matrix=function(b){OW.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(OW.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)}});OW.Monitor=function(a){OW.Monitor._super.call(this);this.levelData=a};JW.extend(OW.Monitor,JW.UI.Component,{renderRoot:function(b){b.mousedown(JW.UI.preventDefault);var a=this.own(new JW.Functor([this.levelData.blinding],function(c){return Math.max(0,1-c/OW.blindingTime)},this)).target;this.own(new JW.UI.CssUpdater(b,"opacity",a))},renderMap:function(f){f.addClass("ow-monitor");f.on("mousedown",".ow-monitor-cell[ow-cell=c3]",JW.inScope(this._onStoneClick,this));var g=this.levelData.map;for(var e=0;e<g.size;++e){var d=jQuery('<div class="ow-monitor-row"></div>');for(var c=0;c<g.size;++c){var a=g.getCell([e,c]);var b=jQuery('<div class="ow-monitor-cell"></div>');b.attr("ow-cell","c"+a);b.attr("ow-i","n"+e);b.attr("ow-j","n"+c);if(e===OW.surfaceI){b.addClass("o-surface")}d.append(b)}d.append('<div class="ow-clear"></div>');f.append(d)}this._updateDigger();this.own(this.levelData.turnEvent.bind(this._updateDigger,this));this.own(this.levelData.cellChangeEvent.bind(this._onCellChange,this))},renderTubes:function(){return this.own(this.levelData.tubes.createMapper({createItem:function(a){return(a.dir%2===0)?new OW.TubeViewV(a):new OW.TubeViewH(a)},destroyItem:JW.destroy,scope:this})).target},renderPunks:function(){return this.own(this.levelData.punks.createMapper({createItem:function(a){return new OW.PunkView(this.levelData,a)},destroyItem:JW.destroy,scope:this})).target},renderPunkWins:function(){return this.own(this.levelData.punkWins.createMapper({createItem:function(a){return new OW.PunkWinView(a)},destroyItem:JW.destroy,scope:this})).target},renderExplosions:function(){return this.own(this.levelData.explosions.createMapper({createItem:function(a){return new OW.ExplosionView(a)},destroyItem:JW.destroy,scope:this})).target},renderPunkPwns:function(a){return this.own(this.levelData.punkPwns.createMapper({createItem:function(b){return new OW.PunkPwnView(b)},destroyItem:JW.destroy,scope:this})).target},_updateDigger:function(){var b=this.getElement("digger");var a=OW.Vector.mult(this.levelData.getFloatIj(),OW.cellSize);OW.El.xy(b,a);b.css("transform","rotate(-"+(90*this.levelData.diggerDir)+"deg)");b.attr("ow-option","o"+(Math.floor(this.levelData.turn/2.5)%3+1))},_getCell:function(a){return this.getElement("map").find(".ow-monitor-cell[ow-i=n"+a[0]+"][ow-j=n"+a[1]+"]")},_onStoneClick:function(c){var b=jQuery(c.currentTarget);var a=[+b.attr("ow-i").substr(1),+b.attr("ow-j").substr(1)];if((this.levelData.diggerOffset===0)&&OW.Vector.equal(a,this.levelData.getDigIj())){if(Math.random()<0.2){this.levelData.setCell(a,OW.map.digged);OW.sound("hit")}else{OW.sound("hit-auto")}}},_onCellChange:function(a){this._getCell(a).attr("ow-cell","c"+this.levelData.map.getCell(a))}});JW.UI.template(OW.Monitor,{main:'<div jwclass="ow-monitor"><div jwid="map"></div><div jwid="tubes"></div><div jwid="digger"></div><div jwid="punks"></div><div jwid="punk-wins"></div><div jwid="explosions"></div><div jwid="punk-pwns"></div></div>'});OW.Progress=function(b,a){OW.Progress._super.call(this);this.value=b;this.total=a};JW.extend(OW.Progress,JW.UI.Component,{renderComplete:function(b){var a=this.own(new JW.Functor([this.value,this.total],function(d,c){return c?(Math.round(100*d/c)+"%"):0},this)).target;this.own(new JW.UI.CssUpdater(b,"width",a))}});JW.UI.template(OW.Progress,{main:'<div jwclass="ow-progress"><div jwid="complete"></div></div>'});OW.Punk=function(a){OW.Punk._super.call(this);this.levelData=a;this.dir=(Math.random()<0.5)?1:-1;this.x=this.own(new JW.Property((this.dir===1)?-20:(OW.mapSize*OW.cellSize+20)));this.speed=0.5+Math.random();this.anim=this.own(new JW.Property(0));this.photo=Math.random()<a.level.probPhoto;this.auto=!this.photo&&(Math.random()<a.level.probAuto);if(this.auto){this.speed=1+Math.random()}this.photed=false;this.photoAnim=this.own(new JW.Property(0))};JW.extend(OW.Punk,JW.Class,{move:function(){if(this.photoAnim.get()){this.photoAnim.set(this.photoAnim.get()-1);if(!this.photoAnim.get()){this.levelData.blinding.set(OW.blindingTime+25);OW.sound("photo")}return}if(this.photo&&!this.photed&&(Math.abs(this.x.get()-OW.mapSize*OW.cellSize/2)<200)&&(Math.random()<0.1)){this.photed=true;this.photoAnim.set(50);return}this.x.set(this.x.get()+this.speed*this.dir);this.anim.set(this.anim.get()+this.speed)},isWin:function(){return Math.abs(this.x.get()-OW.mapSize*OW.cellSize/2)<30}});OW.PunkView=function(b,a){OW.PunkView._super.call(this);this.levelData=b;this.punk=a};JW.extend(OW.PunkView,JW.UI.Component,{renderRoot:function(b){b.addClass("ow-punk");b.addClass("o-"+((this.punk.dir===1)?"right":"left"));if(this.punk.photo){b.addClass("o-photo")}if(this.punk.auto){b.addClass("o-auto")}b.css("top",(OW.cellSize*OW.surfaceI-24)+"px");var c=this.own(new JW.Functor([this.punk.x],function(d){return(d-(this.punk.auto?16:8))+"px"},this)).target;this.own(new JW.UI.CssUpdater(b,"left",c));this.own(new JW.UI.ClassUpdater(b,"o-photing",this.punk.photoAnim));var a=this.own(new JW.Functor([this.punk.anim,this.punk.photoAnim],function(e,d){return d?"0 0":(-(this.punk.auto?32:16)*(Math.floor(e/8)%4)+"px 0")},this)).target;this.own(new JW.UI.CssUpdater(b,"background-position",a));b.mousedown(JW.inScope(this._onMouseDown,this))},_onMouseDown:function(){this.levelData.pwn(this.punk)}});OW.PunkWin=function(){OW.PunkWin._super.call(this);this.dir=(Math.random()<0.5)?1:-1;this.speed=0.5+Math.random();this.anim=this.own(new JW.Property(0))};JW.extend(OW.PunkWin,JW.Class,{move:function(){this.anim.set(this.anim.get()+this.speed)}});OW.PunkWinView=function(a){OW.PunkWinView._super.call(this);this.punkWin=a};JW.extend(OW.PunkWinView,JW.UI.Component,{renderRoot:function(b){b.addClass("ow-punk-win");b.addClass("o-"+((this.punkWin.dir===1)?"right":"left"));b.css("left",(OW.mapSize*OW.cellSize/2+40*Math.random()-25)+"px");b.css("top",(OW.cellSize*OW.surfaceI+10*Math.random()-60)+"px");var a=this.own(new JW.Functor([this.punkWin.anim],function(c){return -24*(Math.floor(c/8)%4)+"px 0"},this)).target;this.own(new JW.UI.CssUpdater(b,"background-position",a))}});OW.PunkPwn=function(b,a){OW.PunkPwn._super.call(this);this.cls=a;this.dir=b.dir;this.x=this.own(new JW.Property(b.x.get()));this.y=this.own(new JW.Property(OW.cellSize*OW.surfaceI-8));
this.dx=-this.dir*(4*Math.random()+1);this.dy=-5*Math.random()-3};JW.extend(OW.PunkPwn,JW.Class,{move:function(){this.x.set(this.x.get()+this.dx);this.y.set(this.y.get()+this.dy);++this.dy},isOut:function(){return(this.x.get()<-16)||(this.x.get()>16+OW.cellSize*OW.mapSize)||(this.y.get()>16+OW.cellSize*OW.mapSize)}});OW.PunkPwnView=function(a){OW.PunkPwnView._super.call(this);this.punkPwn=a};JW.extend(OW.PunkPwnView,JW.UI.Component,{renderRoot:function(a){a.addClass("ow-punk-pwn");a.addClass("o-"+((this.punkPwn.dir===1)?"right":"left"));if(this.punkPwn.cls){a.addClass(this.punkPwn.cls)}var c=this.own(new JW.Functor([this.punkPwn.x],function(d){return(d-8)+"px"},this)).target;this.own(new JW.UI.CssUpdater(a,"left",c));var b=this.own(new JW.Functor([this.punkPwn.y],function(d){return(d-8)+"px"},this)).target;this.own(new JW.UI.CssUpdater(a,"top",b))}});OW.RandomFax=function(a){OW.RandomFax._super.call(this,a)};JW.extend(OW.RandomFax,OW.Quest,{createData:function(a){var b=OW.RandomFax.gens;return new OW.FaxData(a,this,b[Math.floor(b.length*Math.random())]())}});OW.RandomFax.gens=[function(){var e=Math.floor(8*Math.random())+2;var d=Math.floor(8*Math.random())+2;var g=Math.floor(8*Math.random())+2;var f=String.fromCharCode(("A").charCodeAt(0)+Math.floor(26*Math.random()));return{html:"<h3>Question from chief accountant</h3><p>Boss, we have a trouble calculating salary for Mr."+f+"! Only you can help us. We need to count how much is this:</p><p>"+e+" x "+d+" + "+g+"</p>",answer:String(e*d+g),wrongMessage:"Mr."+f+" hasn't got correct salary! Now, as he left, your corporation is paralized."}},function(){var d="";var b="";var f=Math.floor(3*Math.random())+4;for(var a=0;a<14;++a){var e=String.fromCharCode(("a").charCodeAt(0)+Math.floor(26*Math.random()));d+=e;if((a+1)%f===0){b+=e}}return{html:"<h3>Question from decryption team</h3><p>Boss, we have a trouble decrypting Anna Shoutman's message about Greenpeace! Only you can help us. Please write down each "+f+"'th letter in the next word:</p><pre>"+d+"</pre>",answer:b,wrongMessage:"Decryption team has got wrong results and now Anna Shoutman is caught by Greenpeace!"}},function(){var d="";var b="";for(var a=0;a<6;++a){var e=String.fromCharCode(("a").charCodeAt(0)+Math.floor(26*Math.random()));d+=e;b=e+b}return{html:"<h3>Question from decryption team</h3><p>Boss, we have a trouble decrypting Anna Shoutman's message about Greenpeace! Only you can help us. Please write the letters of this word in reverse order:</p><pre>"+d+"</pre>",answer:b,wrongMessage:"Decryption team has got wrong results and now Anna Shoutman is caught by Greenpeace!"}}];OW.Tube=function(b,a){OW.Tube._super.call(this);this.dir=a;this.ij1=this.own(new JW.Property(b));this.ij2=this.own(new JW.Property(b))};JW.extend(OW.Tube,JW.Class);OW.TubeViewH=function(a){OW.TubeViewH._super.call(this);this.tube=a};JW.extend(OW.TubeViewH,JW.UI.Component,{renderRoot:function(a){a.addClass("ow-tube");a.addClass("o-h");this.own(new JW.Updater([this.tube.ij1,this.tube.ij2],function(c,b){j1=Math.min(c[1],b[1]);j2=Math.max(c[1],b[1]);OW.El.xy(a,OW.Vector.mult([c[0],j1+0.5],OW.cellSize));OW.El.size(a,OW.Vector.mult([1,j2-j1],OW.cellSize))},this))}});OW.TubeViewV=function(a){OW.TubeViewV._super.call(this);this.tube=a};JW.extend(OW.TubeViewV,JW.UI.Component,{renderRoot:function(a){a.addClass("ow-tube");a.addClass("o-v");this.own(new JW.Updater([this.tube.ij1,this.tube.ij2],function(c,b){i1=Math.min(c[0],b[0]);i2=Math.max(c[0],b[0]);OW.El.xy(a,OW.Vector.mult([i1+0.5,c[1]],OW.cellSize));OW.El.size(a,OW.Vector.mult([i2-i1,1],OW.cellSize))},this))}});OW.Vector={add:function(d,c){return[d[0]+c[0],d[1]+c[1]]},mult:function(b,d){return[d*b[0],d*b[1]]},equal:function(d,c){return(d[0]===c[0])&&(d[1]===c[1])}};OW.Level.registerItem(new OW.Level({id:"round1",name:"Drill",theme:"siberia",countStone:4,countOil:1}));OW.Level.registerItem(new OW.Level({id:"round2",name:"Greenpeace",theme:"siberia",countStone:6,countOil:2,countSurface:3}));OW.Level.registerItem(new OW.Level({id:"round3",name:"Paparazzi",theme:"siberia",countStone:5,countOil:2,countSurface:5,probPhoto:0.4}));OW.Level.registerItem(new OW.Level({id:"round4",name:"Bequest",theme:"siberia",countStone:6,countOil:4,countSurface:3,probPhoto:0.2,quests:[new OW.Fax({turn:300,duration:1000,html:'<p>Please sign this document up. Sara, secretary</p><h3>Statement of a crime</h3><p>We found a bandit in our Arctic oil platform who was trying to gather information about the penguins who were killed during platform construction. Issue an order to book this guy into Zamoskvoretsky courthouse in Moscow city.</p><p style="color: gray;">Hint: Sign as "Oligarenko".</p><p style="color: gray;">Hint: Leave blank if this is not something you want to sign up.</p>',answer:"Oligarenko",wrongMessage:"Russia won't rise from its knees if you won't sign this up correctly!"}),new OW.Fax({turn:1300,duration:700,html:'<p>Please sign this document up. Sara, secretary</p><h3>Secret scouting order</h3><p>Assign Anna Shoutman to a spy operation against Greenpeace to discover their in-house situation and gather some compromising documents.</p><p style="color: gray;">Hint: Sign as "Oligarenko".</p><p style="color: gray;">Hint: Leave blank if this is not something you want to sign up.</p>',answer:"Oligarenko",wrongMessage:"Russia won't rise from its knees if you won't sign this up correctly!"}),new OW.Fax({turn:2000,duration:500,html:'<p>Please sign this document up. Sara, secretary</p><h3>Bequest</h3><p>I bequeath my corporation, all my money and all my property to Sara, my current secretary.</p><p style="color: gray;">Hint: Sign as "Oligarenko".</p><p style="color: gray;">Hint: Leave blank if this is not something you want to sign up.</p>',answer:"",wrongMessage:"Did you read this? I bet you didn't! ;-)"})]}));OW.Level.registerItem(new OW.Level({id:"round5",name:"Judo buddy",theme:"siberia",countStone:8,countOil:4,countSurface:5,probPhoto:0.2,quests:[new OW.Jail({turn:200,duration:400})]}));OW.Level.registerItem(new OW.Level({id:"round6",name:"Big bang",theme:"siberia",countStone:8,countOil:3,countMetan:8,countSurface:6,probPhoto:0.2,quests:[new OW.RandomFax({turn:500,duration:800}),new OW.RandomFax({turn:1400,duration:750}),new OW.RandomFax({turn:2500,duration:700})]}));OW.Level.registerItem(new OW.Level({id:"round7",name:"Formula 1",theme:"siberia",countStone:8,countOil:4,countMetan:5,countSurface:5,probAuto:1,quests:[new OW.Jail({turn:1000,duration:350})]}));OW.Level.registerItem(new OW.Level({id:"round8",name:"Like Ceasar",theme:"siberia",countStone:10,countOil:4,countMetan:8,countSurface:5,probPhoto:0.2,probAuto:0.4,quests:[new OW.RandomFax({turn:300,duration:700}),new OW.Jail({turn:1100,duration:300}),new OW.RandomFax({turn:1500,duration:900}),new OW.RandomFax({turn:2500,duration:850}),new OW.RandomFax({turn:3500,duration:800})]}));OW.Level.registerItem(new OW.Level({id:"round9",name:"Bitterness",theme:"siberia",countStone:15,countOil:8,countMetan:8,countSurface:10,probPhoto:0.2,probAuto:0.3,quests:[new OW.RandomFax({turn:1000,duration:900}),new OW.RandomFax({turn:2000,duration:800}),new OW.RandomFax({turn:3000,duration:700}),new OW.RandomFax({turn:4000,duration:700}),new OW.RandomFax({turn:5000,duration:700}),new OW.RandomFax({turn:6000,duration:700})]}));var data,app;jQuery(function(){data=new OW.Data();app=new OW.App(data);app.renderTo("body")});